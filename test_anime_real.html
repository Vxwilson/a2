<!DOCTYPE html>
<html>

<head>
    <title>Racing Bar Chart of Exports</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://d3js.org/d3-timer.v2.min.js"></script>

    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
</head>

<body>

    <div class="container">
        <div id="vis"></div>
    </div>
    <script>
        // Vega-Lite specification (with animation)
        const vlSpec = {
            "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
            "description": "Racing Bar Chart of Exports",
            "width": 800,
            "height": 400,
            "data": {
                "name": "data_0",
                "url": "data/exports-calendar-year.csv",
                "format": { "type": "csv" },
              
            },
            "transform": [
                    {
                        "fold": [
                            "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                            "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                            "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
                        ],
                        "as": ["year", "export"]
                    },
                    { "calculate": "parseInt(datum.year)", "as": "yearInt" },
                    {
                        "calculate": "toNumber(datum.export)",
                        "as": "export"
                    },
                    // filter year to start from 1990
                    { "filter": "toNumber(datum.yearInt) == 1990" }
                ],
            "mark": { "type": "bar", "tooltip": true },
            "encoding": {
                "x": { "field": "export", "type": "quantitative", 
                // "axis": null 
            },
                "y": {
                    "field": "exports",
                    "type": "nominal",
                    "sort": "-x"
                },
                "color": { "field": "exports", "type": "nominal" },
                "row": { "field": "yearInt", "type": "ordinal", "header": { "title": "Year" } }
            },
            "config": {
                "view": { "stroke": null }
            }
        };

        // Embed the chart and animate it 
        vegaEmbed('#vis', vlSpec).then(result => {
            const view = result.view;
            let currentYear = 1990; // Start year

            d3.interval(() => {
                // Filter the data after all the initial transformations
                view.data('data_0').then(data => { // Get the current data
                    const filteredData = data.filter(d => d.yearInt == currentYear);
                    view.change('data_0', vega.changeset().remove([]).insert(filteredData)).runAsync();
                });

                currentYear++;
                if (currentYear > 2018) { // Stop at the last year
                    currentYear = 1990; // Reset to the beginning
                }
            }, 500); // Adjust animation speed (milliseconds)
        });
    </script>

</body>

</html>