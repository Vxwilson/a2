<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <link rel="stylesheet" href="css/styles2.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

</head>

<body>
  <div class="header">
    <h1>Data Visualization 2</h1>
    <h2>Pong Vei Xhen 33480982</h2>
  </div>

  <div class="container">
    <div id="vis"></div>
  </div>
  <script>

    const smallmultiplescheme = ['#00429d', '#2e59a8', '#4771b2', '#5d8abd', '#73a2c6', '#8abccf', '#a5d5d8', '#c5eddf', '#ffdec7', '#ffbcaf', '#ff9895', '#f4777f', '#e4576b', '#cf3759', '#b41648', '#93003a']
    const streamGraphScheme = ['#7c739b', '#a57ca5', '#cc86a4', '#ec939c', '#ffa78f', '#ffc184', '#ffdf84']
    const mapGraphScheme = ['#ffffff00', '#8279a5', '#a57ca5', '#cc86a4', '#ec939c', '#ffa78f', '#ffc184', '#ffdf84']
    const streamGraphScheme2 = ['#ffdf84', '#f9c57b', '#efad76', '#e19672', '#cf8270', '#b96f6d', '#a25f68', '#885062']
    const streamGraphScheme3 = ['#7c739b', '#a57ca5', '#cc86a4', '#ec939c', '#ffa78f', '#ffc184', '#ffdf84', '#f9c57b', '#efad76', '#e19672', '#cf8270', '#b96f6d', '#a25f68', '#885062']
    const lineChartScheme = ['#596988', '#a57ca5', '#ec939c', '#ffa78f', '#ffc184', '#ffdf84']
    const blueHueScheme = ['#c1e7ff', '#a7cfe9', '#8eb8d3', '#75a1be', '#5d8ba9', '#437594', '#296080', '#004c6d']
    const coffeeScheme = ['#fff6df', '#f4e6cd', '#e9d6bb', '#dfc6aa', '#d5b699', '#cba78a', '#c2977b', '#c2977b', '#c2977b', '#b8876e', '#b8876e', '#b8876e', '#b8876e', '#b8876e', '#b8876e', '#b8876e', '#b8876e', '#b8876e']
    const blueyellowScheme = ['#003f5c', '#2f4b7c', '#665191', '#a05195', '#d45087', '#f95d6a', '#ff7c43', '#ffa600']
    const blueyellowScheme2 = ['#003f5c', '#7a5195', '#ef5675', '#ffa600']
    const greenScheme = ['#5d7e9c', '#6098b3', '#65b2c5', '#72ccd2', '#89e6db', '#aaffdf']

    const spec2 = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "params": [
        {
          "name": "yearSelection",
          "value": 1990,  // Default year
          "bind": {
            "input": "range",
            "min": 1990, // Assuming data starts from 1990
            "max": 2018, // Replace with the latest year in your data
            "step": 1,
            "name": "Year:"
          }
        }
      ],

      "vconcat": [
        {
          "width": 1000,
          "height": 300,
          "title": { "text": { "signal": "'Coffee Exports in ' + yearSelection" } }, // Use the dynamic title
          "data": {
            // "url": "data/total-production.csv",
            "url": "data/exports-calendar-year.csv",
            "format": { "type": "csv" },
            "name": "exports_data"

          },
          "transform": [
            {
              "fold": [
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
              ],
              "as": ["year", "export"]
            },

            {
              "filter": "toNumber(datum.year) == yearSelection"
            },
            {
              "calculate": "toNumber(datum.export) > 0",
              "as": "hasExport"
            },
            {
              "filter": "datum.hasExport == true"
            },

          ],
          "layer": [
            {

              // string for export tooltip
              "transform": [
                {
                  "calculate": "format(datum.export * 1000 / 1000000, '.3f') + ' million bags (60-kg) of coffee.'",
                  "as": "exporttooltip"
                },
                {
                  "calculate": "toNumber(datum.export)",
                  "as": "export"
                }

              ],
              "mark": {
                "type": "bar",
                "tooltip": true,
                "cornerRadiusEnd": 4,
                "cursor": "pointer",
                "stroke": "#1932c8",
              },
              "encoding": {
                "y": {
                  "field": "export",
                  "type": "quantitative",
                  "title": "Exports (thousand 60kg bags)",
                  // "scale": { "type": "log" }
                },
                "x": {
                  "field": "exports",
                  "type": "nominal",
                  "sort": "-y",
                  "stack": "null",
                  "title": ""
                },
                "fillopacity": {
                  "condition": { "param": "hoveredCountry", "value": 1 },
                  "value": 0.7
                },
                "color": {
                  "field": "export",
                  "type": "quantitative",
                  "scale": {
                    // "range": coffeeScheme
                    "range": streamGraphScheme
                  },
                  "strokeWidth": {
                    "value": 0
                  },
                  "title": "Exports (thousand 60kg bags)"
                },
                "tooltip": [
                  { "field": "exports", "type": "nominal", "title": "Country" },
                  { "field": "exporttooltip", "title": "Exports" }
                ]
              }
            },
            // annotate the longest bar using max
            {
              "transform": [
                { "calculate": "toNumber(datum.export)", "as": "export" },
                { "aggregate": [{ "op": "max", "field": "export", "as": "max_export" }] },
                {
                  "calculate": "split('Brazil alone exported ' + format(datum.max_export * 1000 / 1000000, '.2f') + ' million bags (60-kg) of coffee,\\nleading first place at a huge margin.', '\\n')",
                  "as": "formatted_export"
                }
              ],
              "mark": {
                "type": "text",
                "align": "left",
                "baseline": "middle",
                "format": ".2f",
                "dx": 30,
                "dy": 5,
                "fontSize": 11,
                "fontWeight": "regular",
                "fontStyle": "italic",
                // "color": "#333",
                "color": "#1932c8",
                "lineBreak": "\\n"

              },
              "encoding": {
                "text": { "field": "formatted_export" },
                "y": { "value": 20 },
                "x": { "value": 15 }
              }
            },
            // annotate number of countries + sum of exports
            {
              "transform": [
                // find sum of exports by aggregating
                {
                  "aggregate": [{ "op": "sum", "field": "export", "as": "totalExport" },
                  { "op": "count", "as": "countryCount" }
                  ]
                },
                { "calculate": "split('In ' + yearSelection + ', \\n' + datum.countryCount  + ' countries exported a total of \\n' +  format(datum.totalExport * 1000 / 1000000, '.2f') + ' million bags of coffee.', '\\n')", "as": "countryCount" }
              ],
              "mark": {
                "type": "text",
                "align": "left",
                "baseline": "middle",
                "format": ".2f",
                "dx": 650,
                "dy": 230,
                "fontSize": 11,
                "fontStyle": "italic",
                "fontWeight": "regular",
                // "color": "#333",
                "color": "#1932c8",
              },
              "encoding": {
                "text": { "field": "countryCount" },
                "y": { "value": 20 },
                "x": { "value": 15 }
              }
            },
            {
              "transform": [
                // {
                //   "calculate": "toNumber(datum.year)", // Convert year to number
                //   "as": "year"
                // },
                {
                  "lookup": "year",
                  "from": {
                    "data": {
                      "url": "data/total-population.csv",
                      "format": { "type": "csv", "parse": { "Population": "number" } }
                    },
                    "key": "Year",
                    "fields": ["Population"]
                  },
                  "as": "Population"
                },
                {
                  // "calculate": "toNumber(datum.Population)", "as": "Population"// Convert population to number
                },
                {
                  "aggregate": [{ "op": "sum", "field": "export", "as": "totalExport" }],
                  "groupby": []
                },
                {
                  // "calculate": "datum.totalExport * 1000 * 60 / 25 / 100000000",
                  "calculate": "datum.totalExport * 1000 * 60 / 25 / datum.Population",
                  "as": "cupsPerPerson"
                },
                {
                  "calculate": "'That\\'s ' + format(datum.cupsPerPerson, '.2f') + ' cups of coffee for every single person on Earth!'",
                  "as": "cupsPerPersonText"
                }
              ],
              "mark": {
                "type": "text",
                "align": "left",
                "baseline": "middle",
                "dx": 15,
                "dy": -15,
                "fontSize": 11,
                "fontStyle": "italic",
                "fontWeight": "regular",
                // "color": "#333",
                "color": "#1932c8",
              },
              "encoding": {
                // TODO fix the text Population data
                // "text": { "field": "cupsPerPersonText" },
                // "y": { "value": 280 },
                // "x": { "value": 250 }
              }
            }



          ]
        },
        {
          "title": { "text": "Who's Importing the Coffee?" },

          "width": 1000,
          "height": 350,

          "data": {
            "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
            "format": { "type": "topojson", "feature": "ne_110m_admin_0_countries" }
          },
          "projection": { "type": "equalEarth" },
          "layer": [
            {
              "data": { "graticule": true },
              "mark": { "type": "geoshape", "stroke": "lightgray", "strokeWidth": 0.5 }
            },
            {
              "transform": [
                {
                  "calculate": "'No available data'",
                  "as": "Note"
                }
              ],
              "mark": { "type": "geoshape", "fill": "lightgray", "stroke": "white" },
              "encoding": {
                "tooltip": [
                  { "field": "properties.NAME", "type": "nominal", "title": "Country" },
                  { "field": "Note", "type": "nominal" }
                ]
              }
            },
            {
              "transform": [
                {
                  "lookup": "properties.NAME",
                  "from": {

                    "data": {
                      "url": "data/imports.csv"
                    },
                    "key": "imports",
                    "fields": [
                      "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                      "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                      "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
                    ],
                  }
                },

                {
                  "calculate": "datum[yearSelection]",
                  "as": "Count"
                },
                {
                  "calculate": "format(datum[yearSelection] * 1000 / 1000000, '.3f') + ' million bags (60-kg) of coffee.'",
                  "as": "importtooltip"
                }
              ],
              "mark": {
                "type": "geoshape", "stroke": "white", "cursor": "pointer",
                "stroke": "#1932c8",
                "strokeWidth": 0.5
              },
              "encoding": {
                "color": {
                  "field": "Count",
                  "type": "quantitative",
                  "scale": {
                    // "scheme": "warmgreys"
                    "domain": [0, 0.001, 100, 500, 2000, 6000, 10000, 25000],
                    "range": mapGraphScheme
                  },
                  "legend": {
                    "title": "Imports (thousand 60kg bags)",
                    "disable": true
                  }
                },
                "tooltip": [
                  { "field": "properties.NAME", "type": "nominal", "title": "Country" },
                  {
                    "field": "importtooltip", "title": "imports"
                  }
                ]
              }
            },
          ]
        },
        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",

          "title": { "text": "Top 5 Coffee Exporting Countries Over Time" },
          "width": 1000,
          "height": 400,
          "data": {
            "url": "data/exports_top5_yearly.csv",  // Updated data source
            "format": { "type": "csv" }
          },
          "transform": [
            {
              "calculate": "format(datum.export * 1000 / 1000000, '.2f') + ' million bags'",
              "as": "exporttooltip"
            }
            // Removed aggregate, window, and filter transforms
          ],
          "params": [
            {
              "name": "hoveredCountry",
              "select": {
                "type": "point",
                "fields": ["exports"],
                "on": "mouseover"
              }
            },
            {
              "name": "selectedCountry",
              "select": {
                "type": "point",
                "fields": ["exports"]
              }
            },
            // make opacity 1 for all if nothing is hovered
          ],
          "mark": {
            "type": "area",
            "stroke": "#1932c8",
            "cursor": "pointer"
          },
          "encoding": {
            "x": {
              "field": "year",
              "type": "temporal",
              "axis": {
                "domain": false,
                "format": "%Y",
                "tickSize": 0
              }
            },
            "y": {
              "field": "export",
              "type": "quantitative",
              "axis": null,
              "stack": "center"
            },
            "color": {
              "field": "exports",
              "title": "Exporting Country",
              "scale": {
                "range": streamGraphScheme3
              }
            },

            "opacity": {
              "condition": [
                {
                  "param": "selectedCountry",
                  "value": 1
                },
                // {
                //   "param": "hoveredCountry",
                //   // "empty": false, 
                //   "value": 0.8
                // },
              ],
              "value": 0.6 // Default opacity
            },
            "strokeWidth": {
              "condition": [
                // { "param": "selectedCountry", "value": 2 },
                { "param": "hoveredCountry", "value": 2, "empty": false }
              ],
              "value": 1.25
            },

            "tooltip": [
              { "field": "exports", "type": "nominal", "title": "Country" },
              { "field": "year", "type": "temporal", "title": "Year", "format": "%Y" },
              {
                "field": "exporttooltip",
                "title": "Total Export"
              }
            ]
          }
        },

        // wrap the two charts in a hconcat
        {
          "hconcat": [
            {
              "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
              "title": { "text": "Coffee Prices Over Time" },
              "width": 520,
              "height": 420,
              "data": {
                "url": "data/indicator-prices.csv",
                "format": { "type": "csv" }
              },
              "transform": [
                {
                  "calculate": "timeParse(datum.months, '%m/%Y')",
                  "as": "date"
                },
                {
                  "fold": [
                    // "ICO composite indicator",
                    "Colombian Milds",
                    "Other Milds",
                    "Brazilian Naturals",
                    "Robustas"
                  ],
                  "as": ["Coffee Type", "Price"]
                }
              ],
              // "mark": "line",
              "mark": {
                "type": "line", "size": 1.5, "interpolate": "basis",
                "cursor": "pointer",
              },
              "encoding": {
                "x": {
                  "field": "date",
                  "type": "temporal",
                  "title": "Month/Year",
                  "axis": { "format": "%b %Y" }
                },
                "y": {
                  "field": "Price",
                  "type": "quantitative",
                  "title": "Price (US dollars per kilogram)",
                  "scale": { "zero": false }
                },
                "color": {
                  "field": "Coffee Type",
                  "type": "nominal",
                  "title": "Coffee Type",
                  "scale": {
                    // "scheme": "category20c"
                    // "range": blueyellowScheme2
                    // "range": greenScheme
                    "range": lineChartScheme
                  }
                },
                "tooltip": [
                  { "field": "date", "type": "temporal", "title": "Date", "format": "%b %Y" },
                  { "field": "Coffee Type", "type": "nominal", "title": "Coffee Type" },
                  { "field": "Price", "type": "quantitative", "title": "Price", "format": ".2f" }
                ]
              }
            },
            {

              "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
              // coffee price difference to average
              "title": { "text": "Coffee Price Difference to Average Over Time" },
              "width": 520,
              "height": 420,
              "data": {
                "url": "data/indicator_prices_avgdiff.csv",
                "format": { "type": "csv" }
              },
              "transform": [
                {
                  "calculate": "timeParse(datum.months, '%m/%Y')",
                  "as": "date"
                },
                {
                  "fold": [
                    // "ICO composite indicator",
                    "Colombian Milds",
                    "Other Milds",
                    "Brazilian Naturals",
                    "Robustas"
                  ],
                  "as": ["Coffee Type", "Price"]
                }
              ],
              // "mark": "line",
              "mark": { "type": "line", "size": 1.5, "interpolate": "basis", "cursor": "pointer" },
              "encoding": {
                "x": {
                  "field": "date",
                  "type": "temporal",
                  "title": "Month/Year",
                  "axis": { "format": "%b %Y" }
                },
                "y": {
                  "field": "Price",
                  "type": "quantitative",
                  "title": "",
                  // "title": "Price (US dollars per kilogram)",
                  "scale": { "zero": false }
                },
                "color": {
                  "field": "Coffee Type",
                  "type": "nominal",
                  "title": "Coffee Type"
                },
                "tooltip": [
                  { "field": "date", "type": "temporal", "title": "Date", "format": "%b %Y" },
                  { "field": "Coffee Type", "type": "nominal", "title": "Coffee Type" },
                  { "field": "Price", "type": "quantitative", "title": "Price", "format": ".2f" }
                ]
              }
            }
          ]
        },
        {
          // small multiples of bar chart of prices-paid-to-growers
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "title": { "text": "Prices Paid to Growers Over Time" },
          // "width": 300,
          // "height": 20,
          "data": {
            "url": "data/prices-paid-to-growers.csv",
            "format": { "type": "csv" }
          },
          // fold the data similar to the previous chart to years
          "transform": [
            {
              "fold": [
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
              ],
              "as": ["year", "price"]
            },
            {
              "calculate": "datetime(toNumber(datum.year), 1, 1)",  // Convert year string to date
              "as": "year_date"
            },
            {
              "calculate": "format(datum.price, '.2f') + ' US dollars per kilogram'",
              "as": "pricetooltip"
            }, // filter only Brazil, Colombia, and India
            {
              // "filter": "datum.prices_paid_to_growers == 'Brazil'" +
              //   "|| datum.prices_paid_to_growers == 'Colombia'"
            }
          ],

          "vconcat": [{
            "columns": 3,

            "facet": {
              "field": "prices_paid_to_growers",
              "type": "nominal",
              "title": "Country"
            },
            "spec": {
              "width": 300,
              "height": 60,
              "encoding": {

                "x": {
                  "field": "year_date",
                  "type": "temporal",
                  "axis": {
                    "format": "%Y",
                  },
                  "scale": { "zero": false, "nice": false },
                  "title": "Year"
                },
                "y": {
                  "field": "price",
                  "type": "quantitative",
                  "scale": { "domain": [0, 3] },
                  "title": "Price"
                },
                "color": {
                  "field": "prices_paid_to_growers",
                  "type": "nominal",
                  "scale": {
                    "range": blueyellowScheme
                  },
                  "title": "Country"
                },
                "tooltip": [
                  { "field": "year_date", "type": "temporal", "title": "Year", "format": "%Y" },
                  { "field": "pricetooltip", "title": "Price" }
                ]
              },
              "layer": [
                {
                  "mark": {
                    "type": "line", "clip": true, "orient": "vertical", "opacity": 1,
                    "cursor": "pointer",
                    "stroke": "#1932c8",
                    "strokeWidth": 1.25
                  }
                },
                {

                  "mark": {
                    "type": "area", "clip": true, "orient": "vertical", "opacity": 0.6,
                    "cursor": "pointer",
                    "stroke": "#1932c8",
                    "strokeWidth": 1.25
                  }
                },
                {
                  "transform": [{ "calculate": "datum.price - 3", "as": "ny" }],
                  "mark": {
                    "type": "area", "clip": true, "orient": "vertical",
                    "cursor": "pointer",
                  },
                  "encoding": {

                    "y": {
                      "field": "ny", "type": "quantitative",
                      "scale": { "domain": [0, 3] }
                    },
                    "opacity": { "value": 0.7 }
                  }
                }
              ],
            },
            // add layer for horizon graph
          }],
        },

        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "title": { "text": "Retail Prices over Time" },

          "data": {
            "url": "data/retail-prices.csv",
            "format": { "type": "csv" }
          },
          "transform": [
            {
              "fold": [
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
              ],
              "as": ["year", "price"]
            },
            {
              "calculate": "datetime(toNumber(datum.year), 1, 1)",  // Convert year string to date
              "as": "year_date"
            },
            {
              "calculate": "format(datum.price, '.2f') + ' US dollars per kilogram'",
              "as": "pricetooltip"
            }
          ],


          "width": 300,
          "height": 80,
          "mark": {
            "type": "area",
            "cursor": "pointer",
            "stroke": "#1932c8",
            "strokeWidth": 1.25
          },
          "encoding": {
            "facet": {
              "field": "retail_prices",
              "type": "nominal",
              "columns": 3,
              "title": "Country"
            },
            "x": {
              "field": "year_date",
              "type": "temporal",
              "axis": {
                "format": "%Y"
              },
              "title": "Year"
            },
            "y": {
              "field": "price",
              "type": "quantitative",
              "axis": { "grid": false }
            },
            "color": {
              "field": "retail_prices",
              "type": "nominal",
              "scale": {
                "range": smallmultiplescheme
              },
              "title": "Country"
            },
            "tooltip": [
              { "field": "year_date", "type": "temporal", "title": "Year", "format": "%Y" },
              { "field": "pricetooltip", "title": "Price" }
            ]
          }

        }
      ]
    };

    // use fetch to load the config.json file to be used in the vegaEmbed
    fetch('json/config.json')
      .then(response => response.json())
      .then(configData => {
        // Now configData contains the parsed JSON object
        vegaEmbed("#vis", spec2, {
          mode: "vega-lite",
          renderer: "svg",
          actions: false,
          config: configData
        })
          .then(console.log)
          .catch(console.warn);
      });
  </script>
</body>

</html>