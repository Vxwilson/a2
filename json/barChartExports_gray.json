{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "width": 580,
  "height": 300,
  "title": {
    "text": {
      "signal": "'Coffee Exports in ' + yearSelection"
    }
  },
  "data": {
    "url": "data/exports-calendar-year.csv",
    "format": {
      "type": "csv"
    },
    "name": "exports_data"
  },
  "transform": [
    {
      "fold": [
        "1990",
        "1991",
        "1992",
        "1993",
        "1994",
        "1995",
        "1996",
        "1997",
        "1998",
        "1999",
        "2000",
        "2001",
        "2002",
        "2003",
        "2004",
        "2005",
        "2006",
        "2007",
        "2008",
        "2009",
        "2010",
        "2011",
        "2012",
        "2013",
        "2014",
        "2015",
        "2016",
        "2017",
        "2018"
      ],
      "as": ["year", "export"]
    },
    {
      "filter": "toNumber(datum.year) == yearSelection"
    },
    {
      "calculate": "toNumber(datum.export) > 0",
      "as": "hasExport"
    },
    {
      "filter": "datum.hasExport == true"
    }
  ],
  "params": [
    {
      "name": "yearSelection",
      "value": 1990,
      "bind": {
        "input": "range",
        "min": 1990,
        "max": 2018,
        "step": 1,
        "name": "Year:"
      }
    }
  ],
  "layer": [
    
    {
      "params": [
        {
          "name": "hoveredCountry",
          "select": {
            "type": "point",
            "fields": ["exports"],
            "on": "mouseover"
          }
        },
        {
          "name": "selectedCountry",
          "select": {
            "type": "point",
            "fields": ["exports"]
          }
        },
        {
          "name": "brush",
          "select": { "type": "interval", "encodings": ["x"] }
        }
      ],
      "transform": [
        {
          "calculate": "format(datum.export * 1000 / 1000000, '.3f') + ' million bags (60-kg) of coffee.'",
          "as": "exporttooltip"
        },
        {
          "calculate": "toNumber(datum.export)",
          "as": "export"
        }
      ],
      "mark": {
        "type": "bar",
        "tooltip": true,
        "cornerRadiusEnd": 4,
        "cursor": "pointer",
        "stroke": "#1932c8"
      },
      "encoding": {
        "y": {
          "field": "export",
          "type": "quantitative",
          "title": "Exports (thousand 60kg bags)"
        },
        "x": {
          "field": "exports",
          "type": "nominal",
          "sort": "-y",
          "stack": "null",
          "title": ""
        },
        "color": {
          "field": "export",
          "type": "quantitative",
          "scale": {
            "range": [
              "#7c739b",
              "#a57ca5",
              "#cc86a4",
              "#ec939c",
              "#ffa78f",
              "#ffc184",
              "#ffdf84"
            ]
          },
          "strokeWidth": {
            "value": 0
          },
          "title": "Exports"
        },
        "tooltip": [
          {
            "field": "exports",
            "type": "nominal",
            "title": "Country"
          },
          {
            "field": "exporttooltip",
            "title": "Exports"
          }
        ],
        "opacity": {
          "condition": [

            {
              "param": "brush",
              "value": 1
            }
          ],
          "value": 0.3
        },
        "strokeWidth": {
          "condition": [
            {
              "param": "hoveredCountry",
              "value": 2,
              "empty": false
            }
          ],
          "value": 1.25
        }
      }
    },
  
    {
      "transform": [
        {
          "calculate": "toNumber(datum.export)",
          "as": "export"
        },
        {
          "aggregate": [
            {
              "op": "max",
              "field": "export",
              "as": "max_export"
            }
          ]
        },
        {
          "calculate": "split('Brazil alone exported ' + format(datum.max_export * 1000 / 1000000, '.2f') + ' million bags (60-kg) of coffee,\\nleading first place at a huge margin.', '\\n')",
          "as": "formatted_export"
        }
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "baseline": "middle",
        "format": ".2f",

        "fontSize": 11,
        "fontWeight": "regular",
        "lineBreak": "\\n"
      },
      "encoding": {
        "text": {
          "field": "formatted_export"
        },
        "y": {
          "value": 41
        },
        "x": {
          "value": 50
        }
      }
    },
    
    {
      "transform": [
        {
          "aggregate": [
            {
              "op": "sum",
              "field": "export",
              "as": "totalExport"
            },
            {
              "op": "count",
              "as": "countryCount"
            }
          ]
        },
        {
          "calculate": "split('In ' + yearSelection + ', ' + datum.countryCount  + ' countries exported \\na total of ' +  format(datum.totalExport * 1000 / 1000000, '.2f') + ' million bags.', '\\n')",
          "as": "countryCount"
        }
      ],
      "mark": {
        "type": "text",
        "align": "right",
        "baseline": "middle",
        "format": ".2f",
        "dx": 300,
        "dy": 200,
        "fontSize": 11,
        "fontWeight": "regular"
      },
      "encoding": {
        "text": {
          "field": "countryCount"
        },
        "y": {
          "value": 30
        },
        "x": {
          "value": 275
        }
      }
    },
     {
        "transform": [{
          "filter": {"param": "brush"}
        }],
        "mark": "rule",
        "encoding": {

          "y": {
            "aggregate": "mean",
            "field": "export",
            "type": "quantitative"
          },
          "color": {"value": "#454545"},
          "size": {"value": 3}
        }
        ,
        "zindex": {"value": -10}
      }
      
  ]
}
