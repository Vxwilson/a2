<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <link rel="stylesheet" href="css/styles2.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

</head>

<body>
  <div class="header">
    <h1>Data Visualization 2</h1>
    <h2>Pong Vei Xhen 33480982</h2>
  </div>

  <div class="container">
    <div id="vis"></div>
  </div>
  <script>
    const spec2 = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "config": {
        "style": {
        },
        "font": "Roboto", // Sets the default font for the entire chart
        "title": {
          "font": "Roboto",
          "fontSize": 18,
          "fontWeight": "bold",
          "color": "#333", // Dark gray title color
          "color": "#1932c8"
        },
        "axis": {
          "labelFont": "Roboto",
          "titleFont": "Roboto",
          "titleFontSize": 12,
          "labelColor": "#1932c8",
          "titleColor": "#1932c8"
        },
        "legend": {
          "labelFont": "Roboto",
          "titleFont": "Roboto",
          "labelColor": "#1932c8",
          "titleColor": "#1932c8"
        },
        "view": {
          // "stroke": "transparent" // Remove the border around the chart
        },
        "mark": {
          "color": "#1932c8", // Default color for all marks
        }
      },
      "data": {
        // "url": "data/total-production.csv",
        "url": "data/exports-calendar-year.csv",
        "format": { "type": "csv" },
        "name": "exports_data"

      },
      "params": [
        {
          "name": "yearSelection",
          "value": 1990,  // Default year
          "bind": {
            "input": "range",
            "min": 1990, // Assuming data starts from 1990
            "max": 2018, // Replace with the latest year in your data
            "step": 1,
            "name": "Year:"
          }
        }
      ],
      "transform": [
        {
          "fold": [
            "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
            "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
            "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
          ],
          "as": ["year", "export"]
        },

        {
          "filter": "toNumber(datum.year) == yearSelection"
        },
        {
          "calculate": "toNumber(datum.export) > 0",
          "as": "hasExport"
        },
        {
          "filter": "datum.hasExport == true"
        },
      ],
      "vconcat": [
        {
          "width": 1000,
          "height": 300,
          "title": { "text": { "signal": "'Coffee Exports in ' + yearSelection" } }, // Use the dynamic title

          "layer": [
            {

              // string for export tooltip
              "transform": [
                {
                  "calculate": "format(datum.export * 1000 / 1000000, '.2f') + ' million bags (60-kg) of coffee.'",
                  "as": "exporttooltip"
                },
                {
                  "calculate": "toNumber(datum.export)",
                  "as": "export"
                }

              ],
              "mark": {
                "type": "bar",
                "tooltip": true,
                "cornerRadiusEnd": 4,
                "cursor": "pointer"
              },
              "encoding": {
                "y": {
                  "field": "export",
                  "type": "quantitative",
                  "title": "Exports (thousand 60kg bags)"
                  // "scale": { "type": "log" }
                },
                "x": {
                  "field": "exports",
                  "type": "nominal",
                  "sort": "-y",
                  "stack": "null",
                  "title": ""
                },
                "fillopacity": {
                  "condition": { "param": "hoveredCountry", "value": 1 },
                  "value": 0.7
                },
                "color": {
                  "field": "export",
                  "type": "quantitative",
                  "scale": {
                    // "scheme": "warmgreys"
                    // "scheme": "lightorange"
                    "scheme": "warmgreys"
                  },
                  // "legend": null
                },
                "tooltip": [
                  { "field": "exports", "type": "nominal", "title": "Country" },
                  { "field": "exporttooltip", "title": "Exports" }
                ]
              }
            },
            // annotate the longest bar using max
            {
              "transform": [
                { "calculate": "toNumber(datum.export)", "as": "export" },
                { "aggregate": [{ "op": "max", "field": "export", "as": "max_export" }] },
                {
                  "calculate": "split('Brazil exported ' + format(datum.max_export * 1000 / 1000000, '.2f') + ' million bags (60-kg) of coffee,\\nleading first place at a huge margin.', '\\n')",
                  "as": "formatted_export"
                }
              ],
              "mark": {
                "type": "text",
                "align": "left",
                "baseline": "middle",
                "format": ".2f",
                "dx": 30,
                "dy": 5,
                "fontSize": 13,
                "fontWeight": "bold",
                // "color": "#333",
                "color": "#1932c8",
                "lineBreak": "\\n"
              },
              "encoding": {
                "text": { "field": "formatted_export" },
                "y": { "value": 20 },
                "x": { "value": 15 }
              }
            },
            // annotate number of countries + sum of exports
            {
              "transform": [
                // find sum of exports by aggregating
                {
                  "aggregate": [{ "op": "sum", "field": "export", "as": "totalExport" },
                  { "op": "count", "as": "countryCount" }
                  ]
                },
                { "calculate": "split('In ' + yearSelection + ', \\n' + datum.countryCount  + ' countries exported a total of \\n' +  format(datum.totalExport * 1000 / 1000000, '.2f') + ' million bags of coffee.', '\\n')", "as": "countryCount" }
              ],
              "mark": {
                "type": "text",
                "align": "left",
                "baseline": "middle",
                "format": ".2f",
                "dx": 650,
                "dy": 230,
                "fontSize": 13,
                "fontWeight": "bold",
                // "color": "#333",
                "color": "#1932c8",
              },
              "encoding": {
                "text": { "field": "countryCount" },
                "y": { "value": 20 },
                "x": { "value": 15 }
              }
            }



          ]
        },
        // {
        //   "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        //   "width": 1000, "height": 400,
        //   "data": {
        //     "url": "data/exports-calendar-year.csv",
        //     "format": { "type": "csv" },
        //     "name": "exports_data"

        //   },
        //   "transform": [
        //     {
        //       "fold": [
        //         "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
        //         "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
        //         "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
        //       ],
        //       "as": ["year", "export"]
        //     },
        //     {
        //       "calculate": "datetime(parseInt(datum.year), 1, 1)",  // Convert year string to date
        //       "as": "year_date"
        //     },
        //     // convert export to million bags
        //     {
        //       "calculate": "format(datum.export * 1000 / 1000000, '.2f') + ' million bags'",
        //       "as": "exporttooltip"
        //     }
        //   ],
        //   "mark": "area",
        //   "encoding": {
        //     "x": {
        //       "field": "year_date",
        //       "timeUnit": "year",
        //       "axis": {
        //         "domain": false,
        //         "format": "%Y",
        //         "tickSize": 0
        //       }
        //     },
        //     "y": {
        //       // "aggregate": "sum", "field": "export",
        //       // no need to aggregate as the data is already aggregated
        //       "field": "export",
        //       "type": "quantitative",
        //       "axis": null,
        //       "stack": "center"

        //     },
        //     "color": {
        //       "field": "exports", "scale": {
        //         "scheme": "category20b"
        //       }
        //     },
        //     "tooltip": [ // Add tooltip encoding
        //       { "field": "exports", "type": "nominal", "title": "Country" },
        //       { "field": "year_date", "type": "temporal", "timeUnit": "year", "title": "Year", "format": "%Y" },
        //       {
        //         "field": "exporttooltip",
        //         "title": "Total Export",
        //       }
        //     ]
        //   }
        // },
        // 
        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",

          "title": { "text": "Top 10 Coffee Exporting Countries Over Time" },
          "width": 1000,
          "height": 400,
          "data": {
            "url": "data/exports_top10_yearly.csv",  // Updated data source
            "format": { "type": "csv" }
          },
          "transform": [
            {
              "calculate": "format(datum.export * 1000 / 1000000, '.2f') + ' million bags'",
              "as": "exporttooltip"
            }
            // Removed aggregate, window, and filter transforms
          ],
          "params": [
            {
              "name": "hoveredCountry",
              "select": {
                "type": "point",
                "fields": ["exports"],
                "on": "mouseover"
              }
            },
            {
              "name": "selectedCountry",
              "select": {
                "type": "point",
                "fields": ["exports"]
              }
            },
            // make opacity 1 for all if nothing is hovered
          ],
          "mark": {
            "type": "area",
            "stroke": "#1932c8",
            "cursor": "pointer"
          },
          "encoding": {
            "x": {
              "field": "year",
              "type": "temporal",
              "axis": {
                "domain": false,
                "format": "%Y",
                "tickSize": 0
              }
            },
            "y": {
              "field": "export",
              "type": "quantitative",
              "axis": null,
              "stack": "center"
            },
            "color": {
              "field": "exports",
              "scale": {
                "scheme": "category20c"
                // "scheme": "category20b"
              }
            },

            "opacity": {
              "condition": [
                {
                  "param": "selectedCountry",
                  // "empty": false,
                  "value": 1
                },
                {
                  "param": "hoveredCountry",
                  // "empty": false, 
                  "value": 0.8
                },
              ],
              "value": 0.6 // Default opacity
            },
            "strokeWidth": {
              "condition": [
                // { "param": "selectedCountry", "value": 2 },
                { "param": "hoveredCountry", "value": 2.5, "empty": false }
              ],
              "value": 0
            },

            "tooltip": [
              { "field": "exports", "type": "nominal", "title": "Country" },
              { "field": "year", "type": "temporal", "title": "Year", "format": "%Y" },
              {
                "field": "exporttooltip",
                "title": "Total Export"
              }
            ]
          }
        },

        // wrap the two charts in a hconcat
        {
          "hconcat": [
            {
              "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
              "title": { "text": "Coffee Prices Over Time" },
              "width": 520,
              "height": 420,
              "data": {
                "url": "data/indicator-prices.csv",
                "format": { "type": "csv" }
              },
              "transform": [
                {
                  "calculate": "timeParse(datum.months, '%m/%Y')",
                  "as": "date"
                },
                {
                  "fold": [
                    // "ICO composite indicator",
                    "Colombian Milds",
                    "Other Milds",
                    "Brazilian Naturals",
                    "Robustas"
                  ],
                  "as": ["Coffee Type", "Price"]
                }
              ],
              // "mark": "line",
              "mark": { "type": "line", "size": 2 },
              "encoding": {
                "x": {
                  "field": "date",
                  "type": "temporal",
                  "title": "Month/Year",
                  "axis": { "format": "%b %Y" }
                },
                "y": {
                  "field": "Price",
                  "type": "quantitative",
                  "title": "Price (US dollars per kilogram)",
                  "scale": { "zero": false }
                },
                "color": {
                  "field": "Coffee Type",
                  "type": "nominal",
                  "title": "Coffee Type"
                },
                "tooltip": [
                  { "field": "date", "type": "temporal", "title": "Date", "format": "%b %Y" },
                  { "field": "Coffee Type", "type": "nominal", "title": "Coffee Type" },
                  { "field": "Price", "type": "quantitative", "title": "Price", "format": ".2f" }
                ]
              }
            },
            {

              "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
              // coffee price difference to average
              "title": { "text": "Coffee Price Difference to Average Over Time" },
              "width": 520,
              "height": 420,
              "data": {
                "url": "data/indicator_prices_avgdiff.csv",
                "format": { "type": "csv" }
              },
              "transform": [
                {
                  "calculate": "timeParse(datum.months, '%m/%Y')",
                  "as": "date"
                },
                {
                  "fold": [
                    // "ICO composite indicator",
                    "Colombian Milds",
                    "Other Milds",
                    "Brazilian Naturals",
                    "Robustas"
                  ],
                  "as": ["Coffee Type", "Price"]
                }
              ],
              // "mark": "line",
              "mark": { "type": "line", "size": 2 },
              "encoding": {
                "x": {
                  "field": "date",
                  "type": "temporal",
                  "title": "Month/Year",
                  "axis": { "format": "%b %Y" }
                },
                "y": {
                  "field": "Price",
                  "type": "quantitative",
                  "title": "",
                  // "title": "Price (US dollars per kilogram)",
                  "scale": { "zero": false }
                },
                "color": {
                  "field": "Coffee Type",
                  "type": "nominal",
                  "title": "Coffee Type"
                },
                "tooltip": [
                  { "field": "date", "type": "temporal", "title": "Date", "format": "%b %Y" },
                  { "field": "Coffee Type", "type": "nominal", "title": "Coffee Type" },
                  { "field": "Price", "type": "quantitative", "title": "Price", "format": ".2f" }
                ]
              }
            }
          ]
        },
        {
          // small multiples of bar chart of prices-paid-to-growers
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "title": { "text": "Prices Paid to Growers Over Time" },
          "width": 300,
          "height": 75,
          "data": {
            "url": "data/prices-paid-to-growers.csv",
            "format": { "type": "csv" }
          },
          // fold the data similar to the previous chart to years
          "transform": [
            {
              "fold": [
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
              ],
              "as": ["year", "price"]
            },
            {
              "calculate": "datetime(toNumber(datum.year), 1, 1)",  // Convert year string to date
              "as": "year_date"
            },
            {
              "calculate": "format(datum.price, '.2f') + ' US dollars per kilogram'",
              "as": "pricetooltip"
            }, // filter only Brazil, Colombia, and India
            {
              // "filter": "datum.prices_paid_to_growers == 'Brazil'" +
              //   "|| datum.prices_paid_to_growers == 'Colombia'"
            }
          ],

          "vconcat": [{
            "columns": 3,

            "facet": {
              "field": "prices_paid_to_growers",
              "type": "nominal",
              // "columns": 2,
              "title": "Country"
            },
            "spec": {
              "width": 300,
              "height": 100,
              "encoding": {

                "x": {
                  "field": "year_date",
                  "type": "temporal",
                  "axis": {
                    // "domain": false,
                    "format": "%Y",
                    // "tickSize": 0
                  },
                  "scale": { "zero": false, "nice": false },
                  "title": "Year"
                },
                "y": {
                  "field": "price",
                  "type": "quantitative",
                  // "axis": { "grid": false },
                  "scale": { "domain": [0, 2.5] }
                  // "stack": "center"
                },
                "color": {
                  "field": "prices_paid_to_growers",
                  "type": "nominal",
                  "scale": {
                    "scheme": "category20c"
                  },
                  "title": "Country"
                },
                "tooltip": [
                  { "field": "year_date", "type": "temporal", "title": "Year", "format": "%Y" },
                  { "field": "pricetooltip", "title": "Price" }
                ]
              },
              "layer": [
                {
                  "mark": { "type": "area", "clip": true, "orient": "vertical", "opacity": 0.6 }
                },
                {
                  "transform": [{ "calculate": "datum.price - 2.5", "as": "ny" }],
                  "mark": { "type": "area", "clip": true, "orient": "vertical" },
                  "encoding": {

                    "y": {
                      "field": "ny", "type": "quantitative",
                      "scale": { "domain": [0, 2.5] }
                    },
                    "opacity": { "value": 0.3 }
                  }
                }
              ],
            },
            // add layer for horizon graph
          }],
          "config": {
            "area": {
              "interpolate": "monotone",
              "line": { "interpolate": "monotone" }
            }
          }
        },

        {
          "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
          "title": { "text": "Retail Prices over Time" },

          "data": {
            "url": "data/retail-prices.csv",
            "format": { "type": "csv" }
          },
          "transform": [
            {
              "fold": [
                "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
                "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
                "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
              ],
              "as": ["year", "price"]
            },
            {
              "calculate": "datetime(toNumber(datum.year), 1, 1)",  // Convert year string to date
              "as": "year_date"
            },
            {
              "calculate": "format(datum.price, '.2f') + ' US dollars per kilogram'",
              "as": "pricetooltip"
            }
          ],


          "width": 300,
          "height": 100,
          "mark": {
            "type": "area",
            "interpolate": "linear",
            "line": { "interpolate": "monotone" }
          },
          "encoding": {
            "facet": {
              "field": "retail_prices",
              "type": "nominal",
              "columns": 3,
              "title": "Country"
            },
            "x": {
              "field": "year_date",
              "type": "temporal",
              "axis": {
                "format": "%Y"
              },
              "title": "Year"
            },
            "y": {
              "field": "price",
              "type": "quantitative",
              "axis": { "grid": false }
            },
            "color": {
              "field": "retail_prices",
              "type": "nominal",
              "scale": {
                "scheme": "category20c"
              },
              "title": "Country"
            },
            "tooltip": [
              { "field": "year_date", "type": "temporal", "title": "Year", "format": "%Y" },
              { "field": "pricetooltip", "title": "Price" }
            ]
          }

        },
        // {
        // find use for another data
        //   "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
        //   "title": { "text": "May be useful for another data" },
        //   "width": 300,
        //   "height": 150,  // Adjust height as needed
        //   "data": {
        //     "url": "data/prices-paid-to-growers.csv",
        //     "format": { "type": "csv" }
        //   },
        //   "transform": [
        //     {
        //       "fold": [
        //         "1990", "1991", "1992", "1993", "1994", "1995", "1996", "1997", "1998", "1999",
        //         "2000", "2001", "2002", "2003", "2004", "2005", "2006", "2007", "2008", "2009",
        //         "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018"
        //       ],
        //       "as": ["year", "price"]
        //     },
        //     {
        //       "calculate": "datetime(toNumber(datum.year), 1, 1)",
        //       "as": "year_date"
        //     },
        //     {
        //       "calculate": "format(datum.price, '.2f') + ' US dollars per kilogram'",
        //       "as": "pricetooltip"
        //     }
        //   ],
        //   "mark": {
        //     "type": "area",
        //     "interpolate": "linear",
        //     "line": { "interpolate": "monotone" }
        //   },
        //   "encoding": {
        //     "x": {
        //       "field": "year_date",
        //       "type": "temporal",
        //       "axis": { "format": "%Y", "title": "Year" }
        //     },
        //     "y": {
        //       "field": "price",
        //       "type": "quantitative",
        //       "axis": { "grid": false }
        //     },
        //     "color": {
        //       "field": "prices_paid_to_growers",
        //       "type": "nominal",
        //       "scale": { "scheme": "category20c" },
        //       "title": "Country"
        //     },
        //     "tooltip": [
        //       { "field": "year_date", "type": "temporal", "title": "Year", "format": "%Y" },
        //       { "field": "pricetooltip", "title": "Price" }
        //     ]
        //   },
        //   "repeat": {  // This creates the small multiples
        //     "column": "prices_paid_to_growers"
        //   },
        //   "columns": 2, //  2 columns
        //   "spec": {
        //     "mark": "area",
        //     "encoding": { "y": { "axis": null } } // remove y-axis from other than leftmost chart
        //   }

        // }

      ]
    };
    vegaEmbed("#vis", spec2, { mode: "vega-lite", renderer: "svg" }).then(console.log).catch(console.warn);
  </script>
</body>

</html>